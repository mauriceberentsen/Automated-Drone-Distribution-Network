@startuml
autonumber
participant "Node 1:MeshRouter" as 1
participant "heartbeat:HeartbeatMessage" as 1m
participant "routerTech:IRoutingTechnique" as 1NT
note over 1NT: Table that knows\nthe route towards 2
participant "communication:IWirelessCommunication" as IWS
note over IWS: Interface for wireless communication
participant "Node 2:MeshRouter" as 2


[-> 1  : SendHeartbeat(other = 2) : bool
activate 1
1 -> 1NT ++: towards = NodeTable.getDirectionToNode(other) : uint8_t
return towards = 2 
create 1m
1 -> 1m ++: \t\t\t<<create>>\n msg = HeartbeatMessage(nodeID, nodeID, towards,\n other, connectedToGateway, prefferedGateway)
1 -> 1 : connectedToGateway = false
1 -> 1 ++ : send_message(msg, towards) : bool
1 -> IWS++ : SendMessageTo( msg )
IWS --> 2 +: OnMsg(msg)
1 <- IWS --: succes : bool
deactivate 1m

deactivate 1
deactivate 1

2->2+:processHeartbeat(msg)
alt msg.getKnowGateway() && ! connectedToGateway
    2->2:prefferedGateWay = msg.getPrefferedGateway( )
    2->2:sendHeartbeatToGateway()
else ! msg.getIsGateway() && connectedToGateway
    2->2+:SendHeartbeat(msg.getCreator())
    2->IWS+:SendMessageTo(heartbeat)
    deactivate 2
    deactivate 2
    deactivate 2
    IWS --> 1- : OnMsg(msg)
    activate 1
end



@enduml